% flexchoon.sty - 長音記号の柔軟な伸縮パッケージ
% Description: 長音記号を3等分し、中央部分のみを伸縮させることで
%              フォント形状を保持しながら長音記号を任意の長さに調整

\ProvidesPackage{flexchoon}[2025/09/11 v1.0 Flexible Choon Mark Extension]

% 必要パッケージ
\RequirePackage{trimclip}  % クリッピング機能
\RequirePackage{graphicx}  % スケーリング機能
\RequirePackage{luacode}   % Lua計算機能
\RequirePackage{luatexja-adjust}  % 禁則処理

% 長音記号を3等分して中央部分のみを伸縮させるコマンド（内部実装）
\newcommand{\flexchoon@internal}[1]{%
  \ifnum#1<2 %
    ー% 2未満の場合は通常の長音記号
  \else%
    \begingroup%
      \settowidth{\dimen0}{ー}% 長音記号の基本幅を計算
      \dimen1=\dimexpr\dimen0/3\relax% 1/3の幅（左右端部分）
      % 中央部分を(3*#1-2)倍に伸縮することで全体を#1倍にする
      % 計算式: 全体 = 左端(1/3) + 中央(1/3 × 伸縮率) + 右端(1/3)
      %         #1 = 1/3 + 1/3 × 伸縮率 + 1/3 = 2/3 + 1/3 × 伸縮率
      %         伸縮率 = 3 × (#1 - 2/3) = 3 × #1 - 2
      \rlap{\clipbox{0pt 0pt \dimexpr 2\dimen0/3\relax{} 0pt}{ー}}% 左端部分（固定）
      \rlap{\kern\dimen1\scalebox{\directlua{tex.print(3*#1-2)}}[1]{\clipbox{\dimen1 0pt \dimen1 0pt}{ー}}}% 中央部分（伸縮）
      \rlap{\kern\dimexpr\dimen1+\directlua{tex.print(3*#1-2)}\dimen1\relax\clipbox{\dimexpr 2\dimen0/3\relax{} 0pt 0pt 0pt}{ー}}% 右端部分（固定）
      \kern\dimexpr#1\dimen0\relax% 全体幅=#1倍
    \endgroup%
  \fi%
}

% 行頭禁則処理付きの公開コマンド
% 使用法: \flexchoon{倍率}
% 例: \flexchoon{2} → 2倍の長さの長音記号
% 例: \flexchoon{3} → 3倍の長さの長音記号
\newcommand{\flexchoon}[1]{%
  \penalty10000\flexchoon@internal{#1}% 行頭に来ることを強く抑制
}

% 同義語として\expandchoonも提供
\let\expandchoon\flexchoon

\endinput